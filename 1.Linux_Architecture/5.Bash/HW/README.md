# Описание

Tsykunov Yesterday at 5:15 PM
in webinars-201804
коллеги, в следующую пятницу (не завтра) - у нас урок посвященный bash/sed/awk - и другим полезным скриптовым вещам.
Предлагаю вам к занятию подготовить свои скрипты, которые мы могли бы обсудить на занятии
для примера следующие кейсы
1) watchdog с перезагрузкой процесса/сервиса
2) watchdog  с отсылкой емэйла
3) анализ логов веб сервера/security лога  - (на взлом/скорость ответа/выявление быстрых - медленных запросов, анализ IP  адресов и кол-ва запросов от них)
4) крон скрипт с защитой от мультизапуска
5) любой скрипт на ваше усмотрение, однострочники и регекспы тоже приветствуютсяИ коллеги, т.к. по сути тема большая а у нас одно занятие - напишите в комментариях на что бы вы хотели акцентировать внимание

### Rsync

перенести - кучу мелких файлов общим объемом от 200гиг - на другой сервак.
и далее нюансы
- файлы могут изменяться пока идет перенос
- файлы могут удаляться
- могут появляться новые файлы
- связь может быть нестабильной
- а может быть наоборот стабильное локальное соединение, но объем в пару тер
- а может быть несколько больших файлов - размером по теру каждый

# Однострочники

### Ищем строку в файлах
```bash
grep -r -- "$search" . #Выводит строку
grep -r -l -- "$search" . #Выводит только имя файла
find . -type f -exec grep -l -- "$search" {} \;
```

# Домашнее задание

## Пишем скрипт
подготовить свои скрипты для решения следующих кейсов
1) watchdog с перезагрузкой процесса/сервиса
2) watchdog с отсылкой емэйла
3) анализ логов веб сервера/security лога - (на взлом/скорость ответа/выявление быстрых - медленных запросов, анализ IP адресов и кол-ва запросов от них)
4) крон скрипт с защитой от мультизапуска
5) любой скрипт на ваше усмотрение

желательно чтобы в скрипте были
циклы
условия
регекспы
awk
наличие в скрипте трапов и функций

### Выполнение 

Написал Ansible роли (точнее частично использовал написанные мной ранее) для поднятия Postfix и httpd на vagrant машинке.

Достаточно склонировать репозиторий и дать в этой папке `vagrant up`

1. На VM устанавливается Postfix и отсылает мне письмо об успешной установке.
2. На VM устанавливается Httpd - для тестирования скриптов. Доступен по адресу http://192.168.11.101:80
3. В папку /vagrant в VM, копируются след. скрипты:
- watchdog.sh 

4. Можете изменить почту в переменной ADMIN на свою. Для рассылки используется мой тестовый почтовый ящик.

5. Заходим на виртуалку и запускаем демон
```
bash /vagrant/watchdog.sh start &
```
Демон пишет лог в папку из которой был запущен.

6. Для теста перезапуска сервиса даём:
```
systemctl stop httpd
```

7. По умолчанию демон каждый 30 секунд проверяет запущен ли сервис. Если нет, то отсылает письмо, пишет лог и пытается перезапустить сервис.
